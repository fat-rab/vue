<!--
 * @Author: your name
 * @Date: 2020-12-15 20:20:09
 * @LastEditTime: 2020-12-17 17:14:07
 * @LastEditors: Please set LastEditors
 * @Description: In User Settings Edit
 * @FilePath: \vue\test.html
-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <div id="app"></div>
    <script>
      let active;
      let onChange = function (fn) {
        active = fn;
        active();
        active = null;
      };
      let nextTick = function (cb) {
        Promise.resolve().then(cb);
      };
      let queue = [];
      let queueJob = function (fn) {
        if (!queue.includes(fn)) {
          queue.push(fn);
          nextTick(flushJobs);
        }
      };
      let flushJobs = function () {
        while (queue.length > 0) {
          let job = queue.shift();
          job && job();
        }
      };
      class Dep {
        constructor() {
          this.deps = new Set();
        }
        depend() {
          if (active) {
            this.deps.add(active);
          }
        }
        notify() {
          this.deps.forEach((dep) => queueJob(dep));
        }
      }
      let ref = function (value) {
        let dep = new Dep();
        return Object.defineProperty({}, "value", {
          get() {
            dep.depend();
            return value;
          },
          set(newValue) {
            value = newValue;
            dep.notify();
          },
        });
      };
      let x = ref(1);
      onChange(() => {
        console.log("渲染");
        let str = `hello ${x.value}`;
        document.getElementById("app").innerText = str;
      });

      x.value = 2;
      x.value = 3;
      x.value = 4;
    </script>
  </body>
</html>
